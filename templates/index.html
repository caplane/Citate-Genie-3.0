<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitateGenie - Citation Workbench</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        serif: ['Merriweather', 'Georgia', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .citation-text { font-family: 'Merriweather', serif; }
        
        /* Custom Scrollbar - Slim & Subtle */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            border-top: 2px solid #2563eb;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Citation Item Transitions */
        .citation-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Active State logic */
        .citation-item.active {
            background-color: #fff;
            border-left-color: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Badge Colors */
        .badge-legal { @apply bg-amber-50 text-amber-700 border border-amber-200; }
        .badge-journal { @apply bg-emerald-50 text-emerald-700 border border-emerald-200; }
        .badge-book { @apply bg-blue-50 text-blue-700 border border-blue-200; }
        .badge-url { @apply bg-sky-50 text-sky-700 border border-sky-200; }
        .badge-unknown { @apply bg-slate-50 text-slate-600 border border-slate-200; }

    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-white border-b border-slate-200 h-16 flex-shrink-0 z-30 relative">
        <div class="h-full px-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-brand-600 text-white w-9 h-9 flex items-center justify-center rounded-lg shadow-sm shadow-blue-200">
                    <i class="fas fa-quote-right text-sm"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 tracking-tight leading-none">CitateGenie</h1>
                    <p class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold mt-0.5">Citation Workbench 3.2</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="output-type-badge" class="hidden px-3 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600 border border-slate-200 flex items-center gap-2">
                    </div>
                
                <div id="progress-badge" class="hidden flex items-center gap-2 px-3 py-1 bg-green-50 text-green-700 rounded-full text-xs font-medium border border-green-100">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="progress-text">0/0 reviewed</span>
                </div>

                <div class="h-6 w-px bg-slate-200 mx-1"></div>

                <button onclick="resetDocument()" class="text-slate-500 hover:text-red-600 transition-colors text-sm font-medium" title="Reset Session">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <aside class="w-80 lg:w-96 bg-slate-50 border-r border-slate-200 flex flex-col z-20 shadow-[4px_0_24px_-12px_rgba(0,0,0,0.1)]">
            
            <div class="p-5 border-b border-slate-200 bg-white">
                <input type="file" id="file-input" class="hidden" accept=".docx">
                
                <div id="upload-controls">
                    <div class="mb-4">
                        <label for="style-selector" class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">Target Style</label>
                        <div class="relative">
                            <select id="style-selector" onchange="updateStyleInfo()" class="w-full appearance-none bg-slate-50 hover:bg-slate-100 border border-slate-200 text-slate-700 text-sm rounded-lg pl-3 pr-8 py-2.5 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-shadow cursor-pointer font-medium">
                                <optgroup label="Footnote/Endnote Styles">
                                    <option value="Chicago Manual of Style">Chicago Notes-Bib (17th)</option>
                                    <option value="Bluebook">Bluebook (US Legal)</option>
                                    <option value="OSCOLA">OSCOLA (UK Legal)</option>
                                </optgroup>
                                <optgroup label="Author-Date Styles">
                                    <option value="APA 7">APA 7th Edition</option>
                                    <option value="MLA 9">MLA 9th Edition</option>
                                    <option value="Chicago Author-Date">Chicago Author-Date</option>
                                    <option value="Harvard">Harvard</option>
                                </optgroup>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <span id="style-output-type" class="text-[10px] font-medium text-slate-500 bg-slate-100 px-2 py-0.5 rounded">
                                Footnotes
                            </span>
                            <span id="style-bib-title" class="text-[10px] text-slate-400">→ Bibliography</span>
                        </div>
                    </div>

                    <button onclick="document.getElementById('file-input').click()" id="upload-btn" class="w-full group relative flex flex-col items-center justify-center p-6 border-2 border-dashed border-slate-300 rounded-xl hover:border-brand-500 hover:bg-brand-50 transition-all cursor-pointer">
                        <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center mb-2 group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-cloud-upload-alt text-brand-600 text-lg"></i>
                        </div>
                        <span class="text-sm font-semibold text-slate-700">Upload Document</span>
                        <span class="text-xs text-slate-400 mt-1">.docx files only</span>
                    </button>
                </div>
                
                <div id="upload-loading" class="hidden py-8 flex flex-col items-center justify-center text-slate-500">
                    <div class="loader mb-2"></div>
                    <span class="text-xs font-medium animate-pulse">Analyzing citations...</span>
                </div>
                
                <div id="file-info" class="hidden">
                    <div class="flex items-center gap-3 p-3 bg-brand-50 border border-brand-100 rounded-lg">
                        <div class="bg-brand-100 text-brand-600 w-8 h-8 rounded flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-file-word"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-semibold text-brand-900 truncate" id="file-name-display">filename.docx</p>
                            <p class="text-[10px] text-brand-600">Ready for review</p>
                        </div>
                    </div>
                    
                    <button onclick="downloadDocument()" id="download-area" class="hidden mt-3 w-full bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium py-2.5 rounded-lg shadow-sm hover:shadow transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>

            <div class="px-5 py-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center sticky top-0 z-10">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Detected Citations</span>
                <span id="accepted-count" class="hidden text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">0 Done</span>
                <span id="citation-count" class="text-[10px] bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full font-bold">0</span>
            </div>

            <div id="citation-list" class="flex-1 overflow-y-auto p-3 space-y-1">
                <div id="list-empty" class="h-full flex flex-col items-center justify-center text-center p-8 opacity-40">
                    <i class="fas fa-arrow-up text-4xl mb-4 text-slate-300"></i>
                    <p class="text-sm font-medium text-slate-600">Upload to begin</p>
                </div>
            </div>
        </aside>
        
        <section class="flex-1 flex flex-col bg-slate-100/50 relative">
            
            <div id="panel-empty" class="absolute inset-0 flex items-center justify-center bg-slate-50 z-0">
                <div class="text-center max-w-md mx-auto p-8">
                    <div class="w-24 h-24 bg-white rounded-3xl shadow-lg border border-slate-100 flex items-center justify-center mx-auto mb-8 relative">
                        <div class="absolute inset-0 bg-brand-50 rounded-3xl transform rotate-6 scale-90 -z-10"></div>
                        <i class="fas fa-wand-magic-sparkles text-4xl text-brand-500"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-3">Welcome to CitateGenie</h2>
                    <p class="text-slate-500 mb-8 leading-relaxed">
                        Upload your research paper to automatically extract, format, and standardize your citations into <span class="font-semibold text-slate-700">perfect references</span>.
                    </p>
                    <div class="flex justify-center gap-8 opacity-60">
                        <i class="fab fa-markdown text-3xl hover:text-black transition-colors" title="Markdown Support"></i>
                        <i class="fas fa-file-word text-3xl hover:text-blue-700 transition-colors" title="Word Support"></i>
                        <i class="fas fa-university text-3xl hover:text-brand-700 transition-colors" title="Academic Styles"></i>
                    </div>
                </div>
            </div>
            
            <div id="panel-editor" class="hidden flex-1 flex flex-col overflow-hidden z-10 bg-slate-100/50">
                <div class="flex-1 overflow-y-auto">
                    <div class="max-w-4xl mx-auto p-6 lg:p-10 space-y-8">
                        
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    Review Citation <span id="editor-citation-num" class="text-sm font-normal text-slate-400">#1</span>
                                </h2>
                            </div>
                            <div class="flex items-center gap-2 bg-white rounded-lg shadow-sm border border-slate-200 p-1">
                                <button onclick="adNavigate(-1)" id="btn-prev" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-600 disabled:opacity-30 transition-colors">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span id="editor-position" class="text-xs font-mono text-slate-400 min-w-[60px] text-center">1 / 5</span>
                                <button onclick="adNavigate(1)" id="btn-next" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-600 disabled:opacity-30 transition-colors">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Original Text</label>
                                    <span id="ad-type-badge" class="badge-unknown text-[10px] px-2 py-0.5 rounded font-bold uppercase">UNKNOWN</span>
                                </div>
                                <p id="original-citation-text" class="citation-text text-lg text-slate-700 leading-relaxed italic opacity-80 pl-4 border-l-4 border-slate-200">
                                    (Smith, 2020)
                                </p>
                            </div>

                            <div class="px-8 py-6">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-[11px] font-bold text-brand-600 uppercase tracking-wider flex items-center gap-1">
                                        <i class="fas fa-pen-nib"></i> Formatted Output
                                    </label>
                                    <span id="ad-status-badge" class="text-[10px] font-medium text-slate-400">Auto-generated</span>
                                </div>
                                
                                <div class="relative group">
                                    <textarea id="ad-final-textarea" class="citation-text w-full p-4 bg-white border-2 border-brand-100 rounded-xl text-lg text-slate-800 shadow-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none resize-none min-h-[140px] leading-relaxed transition-all" placeholder="Citation text..."></textarea>
                                    <div class="absolute bottom-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="adCopyToClipboard()" class="w-8 h-8 rounded bg-slate-100 hover:bg-slate-200 text-slate-500 flex items-center justify-center transition-colors" title="Copy">
                                            <i class="fas fa-copy text-xs"></i>
                                        </button>
                                        <button onclick="adKeepOriginal()" class="w-8 h-8 rounded bg-slate-100 hover:bg-slate-200 text-slate-500 flex items-center justify-center transition-colors" title="Reset to Original">
                                            <i class="fas fa-undo text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="px-8 py-4 bg-slate-50 border-t border-slate-200 flex justify-end">
                                <button onclick="adCommitChange()" id="ad-commit-btn" class="bg-brand-600 hover:bg-brand-700 text-white font-medium py-2.5 px-6 rounded-lg shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all flex items-center gap-2">
                                    <span>Accept Reference</span>
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mt-8">
                            <div class="flex items-center justify-between mb-4 px-2">
                                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider">Alternative Matches</h3>
                                <button onclick="adRefreshAlternatives()" class="text-xs text-brand-600 hover:text-brand-800 font-medium flex items-center gap-1">
                                    <i class="fas fa-sync-alt"></i> Refresh Search
                                </button>
                            </div>
                            <div id="ad-alternatives-list" class="grid gap-3">
                                <div class="p-6 bg-white rounded-xl border border-slate-200 text-center text-slate-400">
                                    <i class="fas fa-search mb-2 opacity-50"></i>
                                    <p class="text-xs">Finding matches...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="panel-footnote-editor" class="hidden flex-1 flex flex-col overflow-hidden z-10 bg-slate-100/50">
                <div class="flex-1 overflow-y-auto">
                    <div class="max-w-4xl mx-auto p-6 lg:p-10 space-y-8">
                        
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    Review Footnote <span id="fn-editor-num" class="text-sm font-normal text-slate-400">#1</span>
                                </h2>
                            </div>
                            <div class="flex items-center gap-2 bg-white rounded-lg shadow-sm border border-slate-200 p-1">
                                <button onclick="fnNavigate(-1)" id="fn-btn-prev" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-600 disabled:opacity-30 transition-colors">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span id="fn-editor-position" class="text-xs font-mono text-slate-400 min-w-[60px] text-center">1 / 5</span>
                                <button onclick="fnNavigate(1)" id="fn-btn-next" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-600 disabled:opacity-30 transition-colors">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="px-8 py-5 border-b border-slate-100 bg-slate-50/50 flex items-start gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Raw Footnote Text</label>
                                        <span id="fn-type-badge" class="badge-unknown text-[10px] px-2 py-0.5 rounded font-bold uppercase">UNKNOWN</span>
                                    </div>
                                    <p id="fn-original-text" class="text-sm text-slate-600 italic">loading...</p>
                                </div>
                            </div>

                            <div class="px-8 py-6">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-[11px] font-bold text-brand-600 uppercase tracking-wider flex items-center gap-1">
                                        <i class="fas fa-pen-nib"></i> Formatted Note
                                    </label>
                                </div>
                                <textarea id="fn-final-textarea" class="citation-text w-full p-4 bg-white border-2 border-brand-100 rounded-xl text-lg text-slate-800 shadow-sm focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none resize-none min-h-[140px] leading-relaxed transition-all" placeholder="Formatting..."></textarea>
                            </div>

                            <div class="px-8 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
                                <button onclick="fnAppendMode()" class="text-xs text-slate-500 hover:text-brand-600 font-medium flex items-center gap-1 px-2 py-1 rounded hover:bg-slate-200 transition-colors" title="Add another source to this footnote">
                                    <i class="fas fa-plus-circle"></i> Append Source
                                </button>
                                <div class="flex gap-3">
                                    <button onclick="fnCopyToClipboard()" class="w-10 h-10 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-slate-500 transition-colors">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button onclick="fnCommitChange()" id="fn-commit-btn" class="bg-brand-600 hover:bg-brand-700 text-white font-medium py-2 px-6 rounded-lg shadow-sm hover:shadow-md transition-all flex items-center gap-2">
                                        <i class="fas fa-check"></i> Save Note
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8">
                            <div class="flex items-center justify-between mb-4 px-2">
                                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider">Database Matches</h3>
                                <button onclick="fnSearchAlternatives()" class="text-xs text-brand-600 hover:text-brand-800 font-medium flex items-center gap-1">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div id="fn-alternatives-list" class="grid gap-3">
                                <div class="p-6 bg-white rounded-xl border border-slate-200 text-center text-slate-400">
                                    <div class="loader mx-auto mb-2"></div>
                                    <p class="text-xs">Searching databases...</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <div id="panel-success" class="hidden absolute inset-0 bg-white z-20 flex items-center justify-center">
                <div class="text-center max-w-lg mx-auto p-6">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-[bounce_1s_infinite]">
                        <i class="fas fa-check text-3xl text-green-600"></i>
                    </div>
                    
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">Processing Complete</h2>
                    <p class="text-slate-500 mb-8">Your citations have been standardized and the bibliography generated.</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <span class="block text-3xl font-bold text-slate-800 mb-1" id="final-total">0</span>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Citations</span>
                        </div>
                        <div class="p-4 bg-green-50 rounded-2xl border border-green-100">
                            <span class="block text-3xl font-bold text-green-600 mb-1" id="final-accepted">0</span>
                            <span class="text-xs font-bold text-green-600/70 uppercase tracking-wider">Formatted</span>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="downloadDocument()" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-brand-500/30 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-file-word text-lg"></i> Download DOCX
                        </button>
                        
                        <div class="flex gap-3">
                            <button onclick="exportMetadataCSV()" class="flex-1 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 font-medium py-3 rounded-xl transition-colors text-sm">
                                <i class="fas fa-table mr-2 text-slate-400"></i> Export CSV
                            </button>
                            <button onclick="backToReview()" class="flex-1 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 font-medium py-3 rounded-xl transition-colors text-sm">
                                <i class="fas fa-edit mr-2 text-slate-400"></i> Keep Editing
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="resetDocument()" class="mt-8 text-xs text-slate-400 hover:text-slate-600 font-medium">
                        Start Over
                    </button>
                </div>
            </div>
            
            <div id="processing-overlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center">
                <div class="bg-white rounded-2xl shadow-2xl border border-slate-100 p-8 max-w-sm w-full text-center">
                    <div class="w-12 h-12 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <div class="loader"></div>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 mb-1">Processing</h3>
                    <p id="processing-step" class="text-sm text-slate-500 mb-6">Analyzing document...</p>
                    
                    <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                        <div id="processing-progress" class="bg-brand-500 h-full rounded-full transition-all duration-500" style="width: 10%"></div>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <script>
        /*
         * CitateGenie 3.2 - UI Refactor
         * Logic unchanged from 3.1
         */
        
        let currentSessionId = null;
        let currentCitations = [];
        let activeCitationIndex = -1;
        let selectedOptionIndex = 0;
        let outputType = 'footnote';
        let currentStyle = 'Chicago Manual of Style';
        
        const STYLE_INFO = {
            'Chicago Manual of Style': { type: 'footnote', bib: 'Bibliography' },
            'Bluebook': { type: 'footnote', bib: 'Bibliography' },
            'OSCOLA': { type: 'footnote', bib: 'Bibliography' },
            'APA 7': { type: 'author-date', bib: 'References' },
            'MLA 9': { type: 'author-date', bib: 'Works Cited' },
            'Chicago Author-Date': { type: 'author-date', bib: 'References' },
            'Harvard': { type: 'author-date', bib: 'Bibliography' },
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('file-input').addEventListener('change', handleFileUpload);
            updateStyleInfo();
        });
        
        function updateStyleInfo() {
            currentStyle = document.getElementById('style-selector').value;
            const info = STYLE_INFO[currentStyle] || { type: 'footnote', bib: 'Bibliography' };
            outputType = info.type;
            
            const typeEl = document.getElementById('style-output-type');
            const bibEl = document.getElementById('style-bib-title');
            
            if (info.type === 'footnote') {
                typeEl.innerHTML = 'Footnotes';
                typeEl.className = 'text-[10px] font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded';
            } else {
                typeEl.innerHTML = 'Author-Date';
                typeEl.className = 'text-[10px] font-medium text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded';
            }
            
            bibEl.textContent = `→ ${info.bib}`;
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.docx')) {
                alert('Please upload a .docx file');
                return;
            }
            
            // UI Updates
            document.getElementById('upload-loading').classList.remove('hidden');
            document.getElementById('upload-controls').classList.add('hidden');
            showProcessingOverlay();
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('style', currentStyle);
            
            const styleInfo = STYLE_INFO[currentStyle] || { type: 'footnote' };
            const endpoint = styleInfo.type === 'author-date' 
                ? '/api/process-author-date' 
                : '/api/process';
            
            try {
                updateProcessingStatus('Uploading document...', 20);
                const response = await fetch(endpoint, { method: 'POST', body: formData });
                updateProcessingStatus('Processing citations...', 60);
                const data = await response.json();
                
                if (!data.success) throw new Error(data.error || 'Processing failed');
                
                updateProcessingStatus('Preparing review...', 90);
                currentSessionId = data.session_id;
                currentCitations = data.citations || data.notes || [];
                
                document.getElementById('file-name-display').textContent = file.name;
                document.getElementById('file-info').classList.remove('hidden');
                document.getElementById('upload-loading').classList.add('hidden');
                
                const headerBadge = document.getElementById('output-type-badge');
                headerBadge.classList.remove('hidden');
                
                if (outputType === 'footnote') {
                    headerBadge.innerHTML = '<i class="fas fa-superscript text-blue-500"></i><span>Footnotes</span>';
                } else {
                    headerBadge.innerHTML = '<i class="fas fa-calendar-alt text-emerald-500"></i><span>Author-Date</span>';
                }
                
                document.getElementById('citation-count').textContent = `${currentCitations.length}`;
                
                if (outputType === 'author-date' && currentCitations.length > 0) {
                    renderCitationList();
                    selectCitation(0);
                    document.getElementById('panel-empty').classList.add('hidden');
                    document.getElementById('panel-editor').classList.remove('hidden');
                    document.getElementById('panel-footnote-editor').classList.add('hidden');
                    document.getElementById('panel-success').classList.add('hidden');
                    document.getElementById('progress-badge').classList.remove('hidden');
                    updateProgressBadge();
                } else if (outputType === 'footnote' && currentCitations.length > 0) {
                    fnRenderCitationList();
                    fnLoadEditor(0);
                    document.getElementById('panel-empty').classList.add('hidden');
                    document.getElementById('panel-editor').classList.add('hidden');
                    document.getElementById('panel-footnote-editor').classList.remove('hidden');
                    document.getElementById('panel-success').classList.add('hidden');
                    document.getElementById('download-area').classList.remove('hidden');
                    document.getElementById('progress-badge').classList.remove('hidden');
                    fnUpdateProgressBadge();
                } else {
                    alert('No citations found in document');
                    resetDocument();
                }
                hideProcessingOverlay();
            } catch (error) {
                console.error('Upload error:', error);
                hideProcessingOverlay();
                document.getElementById('upload-loading').classList.add('hidden');
                document.getElementById('upload-controls').classList.remove('hidden');
                alert('Error processing document: ' + error.message);
            }
        }
        
        /* CITATION LIST RENDERER (Cleaned up HTML) */
        function renderCitationList() {
            const container = document.getElementById('citation-list');
            if (currentCitations.length === 0) return;
            
            let html = '';
            currentCitations.forEach((cite, idx) => {
                const isActive = idx === activeCitationIndex;
                const isAccepted = cite.accepted;
                
                let borderClass = isActive ? 'active' : 'border-l-4 border-transparent hover:bg-slate-100';
                let icon = isAccepted ? '<i class="fas fa-check-circle text-green-500 text-xs"></i>' : '<i class="fas fa-circle text-slate-300 text-[8px]"></i>';
                
                html += `
                    <div onclick="selectCitation(${idx})" id="cite-${idx}" 
                         class="citation-item ${borderClass} p-3 cursor-pointer rounded-r-lg group">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[10px] font-bold text-slate-400">#${idx + 1}</span>
                            ${icon}
                        </div>
                        <p class="text-xs text-slate-700 font-medium truncate">${escapeHtml(cite.original || 'Unknown')}</p>
                    </div>
                `;
            });
            container.innerHTML = html;
            updateAcceptedCount();
        }
        
        function selectCitation(idx) {
            if (idx < 0 || idx >= currentCitations.length) return;
            activeCitationIndex = idx;
            const cite = currentCitations[idx];
            
            renderCitationList(); // Re-render to update active class
            
            document.getElementById(`cite-${idx}`)?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            document.getElementById('editor-citation-num').textContent = `#${idx + 1}`;
            document.getElementById('editor-position').textContent = `${idx + 1} / ${currentCitations.length}`;
            
            const isUrl = cite.is_url || false;
            if (isUrl) {
                 document.getElementById('original-citation-text').innerHTML = 
                    `<span class="text-blue-600 underline">${escapeHtml(cite.original)}</span>` +
                    (cite.parenthetical ? `<br><span class="text-sm not-italic text-slate-400 mt-2 block">Parenthetical: ${escapeHtml(cite.parenthetical)}</span>` : '');
            } else {
                document.getElementById('original-citation-text').textContent = cite.original || '(Unknown)';
            }
            
            const typeBadge = document.getElementById('ad-type-badge');
            const cType = isUrl ? 'url' : (cite.options?.[1]?.citation_type || 'unknown');
            typeBadge.textContent = cType.toUpperCase();
            typeBadge.className = `badge-${cType} text-[10px] px-2 py-0.5 rounded font-bold uppercase`;
            
            const statusBadge = document.getElementById('ad-status-badge');
            if (cite.accepted) {
                statusBadge.textContent = 'Saved ✓';
                statusBadge.className = 'text-[10px] font-bold text-green-600 uppercase tracking-wide';
            } else {
                statusBadge.textContent = 'Suggestion';
                statusBadge.className = 'text-[10px] font-bold text-slate-400 uppercase tracking-wide';
            }
            
            document.getElementById('btn-prev').disabled = idx === 0;
            document.getElementById('btn-next').disabled = idx === currentCitations.length - 1;
            
            const textarea = document.getElementById('ad-final-textarea');
            if (cite.formatted) {
                textarea.value = cite.formatted;
            } else if (cite.options && cite.options.length > 1) {
                textarea.value = '';
                textarea.placeholder = 'Loading recommendation...';
                adFormatRecommendedOption(cite);
            } else {
                textarea.value = cite.original || '';
            }
            
            adRenderAlternatives(cite);
        }
        
        async function adFormatRecommendedOption(cite) {
            if (!cite.options || cite.options.length < 2) return;
            try {
                const response = await fetch('/api/accept-reference', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        citation_id: cite.id || cite.note_id,
                        selected_option: 1,
                        style: currentStyle
                    })
                });
                const data = await response.json();
                if (data.success && data.formatted) {
                    cite.formatted = data.formatted;
                    document.getElementById('ad-final-textarea').value = data.formatted;
                }
            } catch (error) { console.error('Format error:', error); }
        }
        
        function adRenderAlternatives(cite) {
            const container = document.getElementById('ad-alternatives-list');
            const options = cite.options || [];
            const alternatives = options.slice(1);
            
            if (alternatives.length === 0) {
                container.innerHTML = `<div class="p-6 bg-slate-50 rounded-xl border border-slate-200 text-center text-slate-400"><p class="text-xs">No automatic matches found.</p></div>`;
                return;
            }
            
            let html = '';
            alternatives.forEach((opt, idx) => {
                const authors = opt.authors?.length > 0 ? opt.authors.slice(0, 3).join(', ') : '';
                const optionIndex = idx + 1;
                
                html += `
                    <div onclick="adSelectAlternative(${optionIndex})" 
                         class="group p-4 bg-white rounded-xl border border-slate-200 hover:border-brand-300 hover:shadow-md cursor-pointer transition-all">
                        <div class="flex items-center justify-between mb-2">
                            <span class="badge-${opt.citation_type || 'unknown'} text-[10px] font-bold uppercase px-2 py-0.5 rounded">${opt.citation_type || 'Unknown'}</span>
                            <span class="text-[10px] text-slate-400 group-hover:text-brand-500">${opt.year || ''}</span>
                        </div>
                        <p class="text-sm font-semibold text-slate-800 mb-1 group-hover:text-brand-700 transition-colors">${escapeHtml(opt.title || 'Untitled')}</p>
                        ${authors ? `<p class="text-xs text-slate-500 mb-1">${escapeHtml(authors)}</p>` : ''}
                        <p class="text-[10px] text-slate-400 truncate">${escapeHtml(opt.journal || opt.publisher || '')}</p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function adSelectAlternative(optionIndex) {
            if (activeCitationIndex < 0) return;
            const cite = currentCitations[activeCitationIndex];
            try {
                const response = await fetch('/api/accept-reference', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId, citation_id: cite.id || cite.note_id, selected_option: optionIndex, style: currentStyle })
                });
                const data = await response.json();
                if (data.success && data.formatted) document.getElementById('ad-final-textarea').value = data.formatted;
            } catch (error) { console.error('Error:', error); }
        }

        function adKeepOriginal() {
            if (activeCitationIndex < 0) return;
            document.getElementById('ad-final-textarea').value = currentCitations[activeCitationIndex].original || '';
        }

        function adCopyToClipboard() {
            const textarea = document.getElementById('ad-final-textarea');
            navigator.clipboard.writeText(textarea.value);
            // Visual feedback handled by CSS transition usually, or simple alert/toast
        }

        async function adRefreshAlternatives() {
            if (activeCitationIndex < 0) return;
            const cite = currentCitations[activeCitationIndex];
            const container = document.getElementById('ad-alternatives-list');
            container.innerHTML = `<div class="p-4 text-center"><div class="loader mx-auto"></div></div>`;
            
            try {
                const response = await fetch('/api/cite/multiple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: cite.original, style: currentStyle, limit: 5 })
                });
                const data = await response.json();
                if (data.success && data.results?.length > 0) {
                    window.adFreshAlternatives = data.results;
                    container.innerHTML = data.results.map((r, i) => `
                        <div onclick="adSelectFreshAlternative(${i})" class="group p-4 bg-white rounded-xl border border-slate-200 hover:border-brand-300 hover:shadow-md cursor-pointer transition-all">
                             <div class="flex items-center justify-between mb-2">
                                <span class="badge-${r.type || 'unknown'} text-[10px] font-bold uppercase px-2 py-0.5 rounded">${r.type || 'Unknown'}</span>
                                <span class="text-[10px] text-slate-400">${r.source || ''}</span>
                            </div>
                            <p class="citation-text text-xs text-slate-700 leading-relaxed">${escapeHtml(r.citation)}</p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `<div class="p-4 text-center text-slate-400 text-xs">No better matches found.</div>`;
                }
            } catch (err) { container.innerHTML = `<div class="p-4 text-center text-red-400 text-xs">Search failed.</div>`; }
        }

        function adSelectFreshAlternative(idx) {
            if (window.adFreshAlternatives && window.adFreshAlternatives[idx]) {
                document.getElementById('ad-final-textarea').value = window.adFreshAlternatives[idx].citation;
            }
        }

        let adSaveInProgress = false;
        async function adCommitChange() {
            if (activeCitationIndex < 0 || !currentSessionId || adSaveInProgress) return;
            adSaveInProgress = true;
            
            const cite = currentCitations[activeCitationIndex];
            const newText = document.getElementById('ad-final-textarea').value;
            const btn = document.getElementById('ad-commit-btn');
            const originalContent = btn.innerHTML;
            
            btn.innerHTML = '<div class="loader border-white border-t-transparent w-4 h-4"></div>';
            
            try {
                const requestBody = { session_id: currentSessionId, reference_id: cite.id || cite.note_id, formatted: newText };
                if (cite.is_url) {
                    requestBody.is_url = true;
                    requestBody.original_url = cite.original_url || cite.original;
                    requestBody.parenthetical = cite.parenthetical || '';
                }
                const response = await fetch('/api/accept-reference', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();
                if (data.success) {
                    cite.formatted = newText;
                    cite.accepted = true;
                    document.getElementById('ad-status-badge').textContent = 'Saved ✓';
                    document.getElementById('ad-status-badge').className = 'text-[10px] font-bold text-green-600 uppercase tracking-wide';
                    renderCitationList();
                    updateAcceptedCount();
                    updateProgressBadge();
                    
                    btn.innerHTML = '<i class="fas fa-check"></i> Saved';
                    btn.classList.add('bg-green-600');
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.classList.remove('bg-green-600');
                        adSaveInProgress = false;
                        const nextUnaccepted = currentCitations.findIndex((c, i) => i > activeCitationIndex && !c.accepted);
                        if (currentCitations.every(c => c.accepted)) showSuccessPanel();
                        else if (nextUnaccepted !== -1) selectCitation(nextUnaccepted);
                    }, 800);
                } else throw new Error(data.error);
            } catch (error) {
                btn.innerHTML = originalContent;
                adSaveInProgress = false;
                alert('Save failed: ' + error.message);
            }
        }

        function adNavigate(delta) {
            const newIndex = activeCitationIndex + delta;
            if (newIndex >= 0 && newIndex < currentCitations.length) selectCitation(newIndex);
        }

        function updateAcceptedCount() {
            const accepted = currentCitations.filter(c => c.accepted).length;
            const el = document.getElementById('accepted-count');
            if (accepted > 0) {
                el.textContent = `${accepted} Done`;
                el.classList.remove('hidden');
            } else el.classList.add('hidden');
        }

        function updateProgressBadge() {
            const accepted = outputType === 'footnote' 
                ? currentCitations.filter(c => c.success).length 
                : currentCitations.filter(c => c.accepted).length;
            document.getElementById('progress-text').textContent = `${accepted}/${currentCitations.length} reviewed`;
        }

        function showSuccessPanel() {
            document.getElementById('panel-editor').classList.add('hidden');
            document.getElementById('panel-footnote-editor').classList.add('hidden');
            document.getElementById('panel-success').classList.remove('hidden');
            document.getElementById('download-area').classList.remove('hidden');
            
            const changedCount = outputType === 'footnote' ? fnSuccessCount : currentCitations.filter(c => c.accepted).length;
            document.getElementById('final-total').textContent = currentCitations.length;
            document.getElementById('final-accepted').textContent = changedCount;
        }

        /* FOOTNOTE MODE LOGIC */
        let fnActiveIndex = -1;
        let fnSuccessCount = 0;
        let fnJustSaved = false;
        let fnSaveInProgress = false;

        function fnRenderCitationList() {
            const container = document.getElementById('citation-list');
            if (currentCitations.length === 0) return;
            
            let html = '';
            currentCitations.forEach((cite, idx) => {
                const isActive = idx === fnActiveIndex;
                const isSuccess = cite.success === true;
                let borderClass = isActive ? 'active' : 'border-l-4 border-transparent hover:bg-slate-100';
                let icon = isSuccess ? '<i class="fas fa-check-circle text-green-500 text-xs"></i>' : '<i class="fas fa-circle text-slate-300 text-[8px]"></i>';
                let noteId = cite.id || idx + 1;
                
                html += `
                    <div id="fn-note-${noteId}" onclick="fnLoadEditor(${idx})" 
                         class="citation-item ${borderClass} p-3 cursor-pointer rounded-r-lg group">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[10px] font-bold text-slate-400">Note ${noteId}</span>
                            ${icon}
                        </div>
                        <p class="text-xs text-slate-700 font-medium truncate">${escapeHtml((cite.text || cite.original || '').substring(0,40))}</p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function fnLoadEditor(idx) {
            if (fnSaveInProgress) return;
            fnActiveIndex = idx;
            fnJustSaved = false;
            const cite = currentCitations[idx];
            
            fnRenderCitationList();
            document.getElementById('fn-editor-num').textContent = `Note ${cite.id || idx + 1}`;
            document.getElementById('fn-editor-position').textContent = `${idx + 1} / ${currentCitations.length}`;
            
            const typeBadge = document.getElementById('fn-type-badge');
            typeBadge.textContent = (cite.type || 'unknown').toUpperCase();
            typeBadge.className = `badge-${cite.type || 'unknown'} text-[10px] px-2 py-0.5 rounded font-bold uppercase`;
            
            document.getElementById('fn-original-text').textContent = cite.text || cite.original || '';
            document.getElementById('fn-final-textarea').value = cite.formatted || '';
            
            document.getElementById('fn-btn-prev').disabled = idx <= 0;
            document.getElementById('fn-btn-next').disabled = idx >= currentCitations.length - 1;
            
            fnSearchAlternatives();
        }

        async function fnSearchAlternatives() {
            const container = document.getElementById('fn-alternatives-list');
            container.innerHTML = `<div class="p-6 text-center"><div class="loader mx-auto"></div></div>`;
            const query = document.getElementById('fn-original-text').textContent;
            
            try {
                const res = await fetch('/api/cite/multiple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, style: currentStyle, limit: 5 })
                });
                const data = await res.json();
                if (data.success && data.results?.length > 0) {
                    window.fnAlternatives = data.results;
                    container.innerHTML = data.results.map((r, i) => `
                        <div onclick="fnSelectAlternative(${i})" class="group p-4 bg-white rounded-xl border border-slate-200 hover:border-brand-300 hover:shadow-md cursor-pointer transition-all">
                             <div class="flex items-center justify-between mb-2">
                                <span class="badge-${r.type || 'unknown'} text-[10px] font-bold uppercase px-2 py-0.5 rounded">${r.type || 'Unknown'}</span>
                                <span class="text-[10px] text-slate-400">${r.source || ''}</span>
                            </div>
                            <p class="citation-text text-xs text-slate-700 leading-relaxed">${escapeHtml(r.citation)}</p>
                        </div>
                    `).join('');
                } else container.innerHTML = `<div class="p-4 text-center text-slate-400 text-xs">No matches found.</div>`;
            } catch (err) { container.innerHTML = `<div class="p-4 text-center text-red-400 text-xs">Search failed.</div>`; }
        }

        function fnSelectAlternative(idx) {
            if (window.fnAlternatives && window.fnAlternatives[idx]) {
                document.getElementById('fn-final-textarea').value = window.fnAlternatives[idx].citation;
            }
        }

        async function fnCommitChange(silent = false) {
            if (fnActiveIndex < 0 || !currentSessionId || fnSaveInProgress) return;
            fnSaveInProgress = true;
            
            const cite = currentCitations[fnActiveIndex];
            const newText = document.getElementById('fn-final-textarea').value;
            const btn = document.getElementById('fn-commit-btn');
            const originalHtml = btn.innerHTML;
            
            if (!silent) btn.innerHTML = '<div class="loader border-white border-t-transparent w-4 h-4"></div>';
            
            try {
                const res = await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId, note_id: cite.id || fnActiveIndex + 1, html: newText })
                });
                const data = await res.json();
                if (data.success) {
                    currentCitations[fnActiveIndex].formatted = newText;
                    if (!currentCitations[fnActiveIndex].success) fnSuccessCount++;
                    currentCitations[fnActiveIndex].success = true;
                    
                    if (!silent) fnJustSaved = true;
                    else fnSaveInProgress = false;
                    
                    fnRenderCitationList();
                    fnUpdateProgressBadge();
                    
                    if (!silent) {
                        btn.innerHTML = '<i class="fas fa-check"></i> Saved';
                        btn.classList.add('bg-green-600');
                        setTimeout(() => {
                            btn.innerHTML = originalHtml;
                            btn.classList.remove('bg-green-600');
                            fnSaveInProgress = false;
                            if (fnActiveIndex < currentCitations.length - 1) fnNavigate(1);
                            else if (currentCitations.every(c => c.success)) showSuccessPanel();
                        }, 800);
                    }
                } else { throw new Error(data.error); }
            } catch (err) {
                fnSaveInProgress = false;
                if (!silent) {
                    btn.innerHTML = originalHtml;
                    alert('Failed to save changes');
                }
            }
        }

        async function fnNavigate(delta) {
            if (fnJustSaved) fnJustSaved = false;
            else {
                const textarea = document.getElementById('fn-final-textarea');
                if (fnActiveIndex >= 0 && textarea && textarea.value.trim()) await fnCommitChange(true);
            }
            const newIdx = fnActiveIndex + delta;
            if (newIdx >= 0 && newIdx < currentCitations.length) fnLoadEditor(newIdx);
        }

        function fnCopyToClipboard() {
            const textarea = document.getElementById('fn-final-textarea');
            navigator.clipboard.writeText(textarea.value);
        }

        function fnAppendMode() {
            const textarea = document.getElementById('fn-final-textarea');
            textarea.value = textarea.value.trim() + '; ';
            textarea.focus();
        }

        function backToReview() {
            document.getElementById('panel-success').classList.add('hidden');
            if (outputType === 'footnote') {
                document.getElementById('panel-footnote-editor').classList.remove('hidden');
                fnLoadEditor(0);
            } else {
                document.getElementById('panel-editor').classList.remove('hidden');
            }
        }

        async function downloadDocument() {
            if (!currentSessionId) return;
            try {
                if (outputType === 'author-date') {
                    await fetch('/api/finalize-author-date', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: currentSessionId, references: [] })
                    });
                }
                const response = await fetch(`/api/download/${currentSessionId}`);
                if (!response.ok) throw new Error('Download failed');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `citategenie_processed.docx`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (error) { alert('Error: ' + error.message); }
        }

        async function exportMetadataCSV() {
            if (!currentSessionId) return;
            try {
                const response = await fetch(`/api/export-metadata/${currentSessionId}`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `citategenie_citations.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (error) { alert('Error exporting: ' + error.message); }
        }

        function resetDocument() {
            currentSessionId = null;
            currentCitations = [];
            activeCitationIndex = -1;
            selectedOptionIndex = 0;
            fnActiveIndex = -1;
            fnSuccessCount = 0;
            fnJustSaved = false;
            fnSaveInProgress = false;
            adSaveInProgress = false;
            
            document.getElementById('file-input').value = '';
            document.getElementById('file-info').classList.add('hidden');
            document.getElementById('download-area').classList.add('hidden');
            document.getElementById('upload-controls').classList.remove('hidden');
            document.getElementById('upload-loading').classList.add('hidden');
            document.getElementById('output-type-badge').classList.add('hidden');
            document.getElementById('progress-badge').classList.add('hidden');
            document.getElementById('accepted-count').classList.add('hidden');
            document.getElementById('citation-count').textContent = '0';
            
            document.getElementById('panel-empty').classList.remove('hidden');
            document.getElementById('panel-editor').classList.add('hidden');
            document.getElementById('panel-footnote-editor').classList.add('hidden');
            document.getElementById('panel-success').classList.add('hidden');
            
            document.getElementById('citation-list').innerHTML = `<div id="list-empty" class="h-full flex flex-col items-center justify-center text-center p-8 opacity-40"><i class="fas fa-arrow-up text-4xl mb-4 text-slate-300"></i><p class="text-sm font-medium text-slate-600">Upload to begin</p></div>`;
        }
        
        function showProcessingOverlay() { document.getElementById('processing-overlay').classList.remove('hidden'); }
        function hideProcessingOverlay() { document.getElementById('processing-overlay').classList.add('hidden'); }
        function updateProcessingStatus(message, progress) {
            document.getElementById('processing-step').textContent = message;
            document.getElementById('processing-progress').style.width = `${progress}%`;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
