<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitateGenie - Citation Workbench</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /*
         * CitateGenie - Unified Citation Workbench
         * Version: 3.0.0
         * Updated: 2025-12-12
         * 
         * V3.0.0 Changes:
         * - REMOVED mode toggle - style determines output format
         * - Single /api/process-unified endpoint
         * - Style-driven workflow: footnote or author-date based on style
         * - Simplified UI with automatic format detection
         */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .serif { font-family: 'Merriweather', serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top: 3px solid #2563eb;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Citation type badges */
        .badge-legal { background: #fef3c7; color: #92400e; }
        .badge-journal { background: #d1fae5; color: #065f46; }
        .badge-book { background: #dbeafe; color: #1e40af; }
        .badge-medical { background: #fce7f3; color: #9d174d; }
        .badge-interview { background: #e0e7ff; color: #3730a3; }
        .badge-newspaper { background: #f3e8ff; color: #6b21a8; }
        .badge-government { background: #fee2e2; color: #991b1b; }
        .badge-url { background: #ecfdf5; color: #047857; }
        .badge-unknown { background: #f1f5f9; color: #475569; }
        
        /* Status indicators */
        .status-success { border-left: 3px solid #22c55e; background: #f0fdf4; }
        .status-error { border-left: 3px solid #ef4444; background: #fef2f2; }
        .status-pending { border-left: 3px solid #f59e0b; background: #fffbeb; }
        .status-active { border-left: 3px solid #3b82f6; background: #eff6ff; }
        
        /* Style groups */
        .style-group-label {
            font-size: 10px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 8px 12px 4px;
            background: #f8fafc;
        }
        
        /* Output type indicator */
        .output-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 500;
        }
        .output-footnote { background: #dbeafe; color: #1e40af; }
        .output-author-date { background: #d1fae5; color: #047857; }
        
        /* Reference item */
        .reference-item {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            margin-bottom: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .reference-item:hover { border-color: #3b82f6; }
        .reference-item.resolved { border-left: 3px solid #22c55e; }
        .reference-item.failed { border-left: 3px solid #ef4444; background: #fef2f2; }
        .reference-item.active { border-color: #3b82f6; ring: 2px; ring-color: #3b82f6; background: #eff6ff; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-20 px-6 h-16 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center gap-4">
            <div class="bg-gradient-to-br from-blue-600 to-indigo-600 text-white w-10 h-10 flex items-center justify-center rounded-lg shadow-sm">
                <i class="fas fa-quote-left text-lg"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight">CitateGenie</h1>
                <p class="text-xs text-gray-500 font-medium">Style-Driven Citation Processor <span class="text-blue-600">v3.0</span></p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <div id="output-type-badge" class="hidden output-indicator output-footnote">
                <i class="fas fa-superscript"></i>
                <span>Footnotes</span>
            </div>
            <button onclick="window.location.reload()" class="text-gray-500 hover:text-gray-700 font-medium text-sm px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                <i class="fas fa-redo mr-1"></i> Reset
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Left Sidebar: Upload & Citation List -->
        <aside class="w-80 lg:w-96 bg-white border-r border-gray-200 flex flex-col z-10 flex-shrink-0">
            
            <!-- Upload Area -->
            <div class="p-4 border-b border-gray-100 bg-gradient-to-b from-gray-50 to-white">
                <input type="file" id="file-input" class="hidden" accept=".docx">
                <button onclick="document.getElementById('file-input').click()" class="w-full border-2 border-dashed border-gray-300 rounded-xl p-5 text-center hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer group flex flex-col items-center gap-2">
                    <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 group-hover:text-blue-500 transition-colors"></i>
                    <span class="text-sm font-medium text-gray-600 group-hover:text-blue-700">Upload Document (.docx)</span>
                    <span id="upload-hint" class="text-xs text-gray-400">Style determines output format automatically</span>
                </button>
                
                <!-- Style Selector -->
                <div class="mt-3">
                    <label for="style-selector" class="text-xs font-medium text-gray-600 mb-1 block">Citation Style:</label>
                    <select id="style-selector" onchange="updateStyleInfo()" class="w-full text-sm border border-gray-300 rounded-lg bg-white text-gray-700 h-10 px-3 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none cursor-pointer">
                        <optgroup label="ðŸ“ Footnote/Endnote Styles">
                            <option value="Chicago Manual of Style">Chicago Notes-Bib (17th)</option>
                            <option value="Bluebook">Bluebook (US Legal)</option>
                            <option value="OSCOLA">OSCOLA (UK Legal)</option>
                        </optgroup>
                        <optgroup label="ðŸ“– Author-Date Styles">
                            <option value="APA 7">APA 7th Edition</option>
                            <option value="MLA 9">MLA 9th Edition</option>
                            <option value="Chicago Author-Date">Chicago Author-Date</option>
                            <option value="Harvard">Harvard</option>
                        </optgroup>
                    </select>
                    <div id="style-info" class="mt-2 text-xs text-gray-500 flex items-center gap-2">
                        <span id="style-output-type" class="output-indicator output-footnote">
                            <i class="fas fa-superscript"></i> Footnotes
                        </span>
                        <span id="style-bib-title" class="text-gray-400">â†’ Bibliography</span>
                    </div>
                </div>
                
                <div id="upload-loading" class="hidden mt-3 flex items-center justify-center gap-2 text-xs text-gray-500">
                    <div class="loader w-4 h-4"></div> <span>Parsing document...</span>
                </div>
                
                <div id="file-info" class="hidden mt-3 flex items-center justify-between bg-blue-50 px-3 py-2 rounded-lg">
                    <span class="text-sm text-blue-700 font-medium truncate" id="file-name-display"></span>
                    <button onclick="resetDocument()" class="text-blue-600 hover:text-blue-800 text-xs">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="download-area" class="hidden mt-3">
                    <button onclick="downloadDocument()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-medium py-2.5 px-4 rounded-lg transition-all text-sm shadow-sm flex items-center justify-center gap-2">
                        <i class="fas fa-file-download"></i> Download Processed Document
                    </button>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="px-4 py-2 bg-white border-b border-gray-100 flex justify-between items-center">
                <span id="list-label" class="text-xs font-bold text-gray-400 uppercase tracking-wider">Citations</span>
                <div class="flex items-center gap-2">
                    <span id="success-count" class="hidden text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">0 done</span>
                    <span id="citation-count" class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600 font-medium">0 total</span>
                </div>
            </div>

            <!-- Citation List -->
            <div id="citation-list" class="flex-1 overflow-y-auto p-3">
                <div id="list-empty" class="text-center py-12 text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-3 opacity-30"></i>
                    <p class="text-sm font-medium">Upload a document to begin</p>
                    <p class="text-xs mt-1 text-gray-300">Style determines footnotes vs. author-date</p>
                </div>
            </div>
        </aside>
        
        <!-- Right Panel: Info & Success State -->
        <section class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
            
            <!-- Empty State (before upload) -->
            <div id="editor-empty" class="flex-1 flex items-center justify-center">
                <div class="text-center max-w-md mx-auto p-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-file-alt text-3xl text-blue-500"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-700 mb-2">Upload a Document</h2>
                    <p class="text-gray-500 text-sm mb-6">
                        CitateGenie automatically detects citation format from your chosen style.
                    </p>
                    <div class="bg-white rounded-xl p-4 border border-gray-200 text-left">
                        <p class="text-xs font-semibold text-gray-600 mb-2">How it works:</p>
                        <ol class="text-xs text-gray-500 space-y-2">
                            <li class="flex items-start gap-2">
                                <span class="bg-blue-100 text-blue-700 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 text-[10px] font-bold">1</span>
                                <span>Select your citation style (APA, Chicago, MLA, etc.)</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="bg-blue-100 text-blue-700 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 text-[10px] font-bold">2</span>
                                <span>Upload your .docx document</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="bg-blue-100 text-blue-700 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 text-[10px] font-bold">3</span>
                                <span>Citations are processed automatically based on style</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="bg-blue-100 text-blue-700 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 text-[10px] font-bold">4</span>
                                <span>Download your formatted document</span>
                            </li>
                        </ol>
                    </div>
                    
                    <!-- Style explanations -->
                    <div class="mt-6 grid grid-cols-2 gap-3 text-left">
                        <div class="bg-blue-50 rounded-lg p-3 border border-blue-100">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-superscript text-blue-600"></i>
                                <span class="text-xs font-bold text-blue-800">Footnote Styles</span>
                            </div>
                            <p class="text-[10px] text-blue-600">Chicago Notes, Bluebook, OSCOLA</p>
                            <p class="text-[10px] text-blue-500 mt-1">â†’ Formats your footnotes/endnotes</p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3 border border-green-100">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-user-clock text-green-600"></i>
                                <span class="text-xs font-bold text-green-800">Author-Date Styles</span>
                            </div>
                            <p class="text-[10px] text-green-600">APA, MLA, Chicago AD, Harvard</p>
                            <p class="text-[10px] text-green-500 mt-1">â†’ In-text cites + References</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Success State (after processing) -->
            <div id="success-panel" class="hidden flex-1 flex items-center justify-center">
                <div class="text-center max-w-lg mx-auto p-8">
                    <div class="w-24 h-24 bg-gradient-to-br from-green-400 to-emerald-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                        <i class="fas fa-check text-4xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Document Processed!</h2>
                    <p id="success-message" class="text-gray-500 mb-6">
                        Your citations have been formatted and your document is ready.
                    </p>
                    
                    <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <p id="stat-found" class="text-3xl font-bold text-gray-800">0</p>
                                <p class="text-xs text-gray-500">Citations Found</p>
                            </div>
                            <div>
                                <p id="stat-resolved" class="text-3xl font-bold text-green-600">0</p>
                                <p class="text-xs text-gray-500">Successfully Resolved</p>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="downloadDocument()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-4 px-8 rounded-xl transition-all text-lg shadow-lg hover:shadow-xl flex items-center justify-center gap-3 w-full">
                        <i class="fas fa-download"></i>
                        Download Processed Document
                    </button>
                    
                    <button onclick="resetDocument()" class="mt-4 text-gray-500 hover:text-gray-700 text-sm">
                        <i class="fas fa-redo mr-1"></i> Process Another Document
                    </button>
                </div>
            </div>
            
            <!-- Processing Overlay -->
            <div id="processing-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 text-center">
                    <div class="mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full mb-4">
                            <i class="fas fa-magic text-white text-2xl animate-pulse"></i>
                        </div>
                        <h3 id="processing-title" class="text-xl font-bold text-gray-800">Processing Document</h3>
                        <p id="processing-subtitle" class="text-gray-500 text-sm mt-1">Analyzing your citations...</p>
                    </div>
                    
                    <div class="space-y-3">
                        <div id="processing-status" class="text-sm text-gray-600">
                            <span class="inline-block w-2 h-2 bg-blue-500 rounded-full animate-ping mr-2"></span>
                            <span id="processing-step">Extracting citations...</span>
                        </div>
                        
                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div id="processing-progress" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-500" style="width: 10%"></div>
                        </div>
                        
                        <p class="text-xs text-gray-400 mt-4">
                            This may take a moment for complex documents
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        /*
         * CitateGenie 3.0 - Frontend JavaScript
         * Style-driven processing - no mode selection
         */
        
        // ========== STATE ==========
        let currentSessionId = null;
        let currentCitations = [];
        let activeCitationIndex = -1;
        let outputType = 'footnote';  // Will be set by style
        
        // Style info mapping
        const STYLE_INFO = {
            'Chicago Manual of Style': { type: 'footnote', bib: 'Bibliography' },
            'Bluebook': { type: 'footnote', bib: 'Bibliography' },
            'OSCOLA': { type: 'footnote', bib: 'Bibliography' },
            'APA 7': { type: 'author-date', bib: 'References' },
            'MLA 9': { type: 'author-date', bib: 'Works Cited' },
            'Chicago Author-Date': { type: 'author-date', bib: 'References' },
            'Harvard': { type: 'author-date', bib: 'Bibliography' },
        };
        
        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            // File input handler
            document.getElementById('file-input').addEventListener('change', handleFileUpload);
            
            // Initialize style info
            updateStyleInfo();
        });
        
        // ========== STYLE INFO ==========
        function updateStyleInfo() {
            const style = document.getElementById('style-selector').value;
            const info = STYLE_INFO[style] || { type: 'footnote', bib: 'Bibliography' };
            
            outputType = info.type;
            
            // Update indicator
            const typeEl = document.getElementById('style-output-type');
            const bibEl = document.getElementById('style-bib-title');
            
            if (info.type === 'footnote') {
                typeEl.innerHTML = '<i class="fas fa-superscript"></i> Footnotes';
                typeEl.className = 'output-indicator output-footnote';
            } else {
                typeEl.innerHTML = '<i class="fas fa-user-clock"></i> Author-Date';
                typeEl.className = 'output-indicator output-author-date';
            }
            
            bibEl.textContent = `â†’ ${info.bib}`;
            
            // Update header badge if visible
            const headerBadge = document.getElementById('output-type-badge');
            if (!headerBadge.classList.contains('hidden')) {
                if (info.type === 'footnote') {
                    headerBadge.innerHTML = '<i class="fas fa-superscript"></i><span>Footnotes</span>';
                    headerBadge.className = 'output-indicator output-footnote';
                } else {
                    headerBadge.innerHTML = '<i class="fas fa-user-clock"></i><span>Author-Date</span>';
                    headerBadge.className = 'output-indicator output-author-date';
                }
            }
        }
        
        // ========== FILE UPLOAD ==========
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.name.endsWith('.docx')) {
                alert('Please upload a .docx file');
                return;
            }
            
            // Show loading state
            document.getElementById('upload-loading').classList.remove('hidden');
            document.getElementById('file-info').classList.add('hidden');
            document.getElementById('download-area').classList.add('hidden');
            
            // Show processing overlay
            showProcessingOverlay();
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('style', document.getElementById('style-selector').value);
            
            try {
                updateProcessingStatus('Uploading document...', 20);
                
                // Use the unified endpoint
                const response = await fetch('/api/process-unified', {
                    method: 'POST',
                    body: formData
                });
                
                updateProcessingStatus('Processing citations...', 50);
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Processing failed');
                }
                
                updateProcessingStatus('Formatting results...', 80);
                
                // Store session info
                currentSessionId = data.session_id;
                outputType = data.output_type || 'footnote';
                
                // Get stats from response
                const stats = data.stats || {};
                const citationsFound = stats.citations_found || 0;
                const citationsResolved = stats.citations_resolved || 0;
                
                // Update UI
                document.getElementById('file-name-display').textContent = file.name;
                document.getElementById('file-info').classList.remove('hidden');
                document.getElementById('download-area').classList.remove('hidden');
                document.getElementById('upload-loading').classList.add('hidden');
                
                // Show output type in header
                const headerBadge = document.getElementById('output-type-badge');
                headerBadge.classList.remove('hidden');
                if (outputType === 'footnote') {
                    headerBadge.innerHTML = '<i class="fas fa-superscript"></i><span>Footnotes</span>';
                    headerBadge.className = 'output-indicator output-footnote';
                } else {
                    headerBadge.innerHTML = '<i class="fas fa-user-clock"></i><span>Author-Date</span>';
                    headerBadge.className = 'output-indicator output-author-date';
                }
                
                // Update stats
                document.getElementById('citation-count').textContent = `${citationsFound} total`;
                if (citationsResolved > 0) {
                    document.getElementById('success-count').textContent = `${citationsResolved} resolved`;
                    document.getElementById('success-count').classList.remove('hidden');
                }
                
                // Show processing summary instead of citation list
                showProcessingSummary(stats, data.bibliography_title || 'References');
                
                // Hide empty state, show success panel
                document.getElementById('list-empty').classList.add('hidden');
                document.getElementById('editor-empty').classList.add('hidden');
                document.getElementById('success-panel').classList.remove('hidden');
                
                // Update success panel stats
                document.getElementById('stat-found').textContent = citationsFound;
                document.getElementById('stat-resolved').textContent = citationsResolved;
                
                // Update success message based on output type
                const successMsg = outputType === 'footnote'
                    ? `Your footnotes have been formatted in ${style}.`
                    : `Your citations have been formatted with a ${data.bibliography_title || 'References'} section.`;
                document.getElementById('success-message').textContent = successMsg;
                
                updateProcessingStatus('Complete!', 100);
                
                // Hide overlay after brief delay
                setTimeout(hideProcessingOverlay, 500);
                
            } catch (error) {
                console.error('Upload error:', error);
                hideProcessingOverlay();
                document.getElementById('upload-loading').classList.add('hidden');
                alert('Error processing document: ' + error.message);
            }
        }
        
        // ========== CITATION LIST (placeholder for future enhancement) ==========
        function renderCitationList() {
            // Will be implemented when backend returns individual citations
            console.log('Citation list rendering - future feature');
        }
        
        // ========== CITATION EDITOR ==========
        function selectCitation(idx) {
            if (idx < 0 || idx >= currentCitations.length) return;
            
            activeCitationIndex = idx;
            const cite = currentCitations[idx];
            
            // Update list highlighting
            document.querySelectorAll('.reference-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`cite-${idx}`);
            if (activeEl) activeEl.classList.add('active');
            
            // Update editor
            document.getElementById('active-citation-id').textContent = `#${idx + 1}`;
            
            const typeEl = document.getElementById('active-citation-type');
            typeEl.textContent = cite.type || 'unknown';
            typeEl.className = `text-[10px] font-bold uppercase px-2 py-0.5 rounded badge-${cite.type || 'unknown'}`;
            
            document.getElementById('original-citation').textContent = cite.original || 'â€”';
            document.getElementById('formatted-citation').value = cite.formatted || cite.original || '';
        }
        
        function prevCitation() {
            if (activeCitationIndex > 0) {
                selectCitation(activeCitationIndex - 1);
            }
        }
        
        function nextCitation() {
            if (activeCitationIndex < currentCitations.length - 1) {
                selectCitation(activeCitationIndex + 1);
            }
        }
        
        async function acceptCitation() {
            if (activeCitationIndex < 0) return;
            
            const newFormatted = document.getElementById('formatted-citation').value;
            const cite = currentCitations[activeCitationIndex];
            
            // Update local state
            cite.formatted = newFormatted;
            cite.success = true;
            
            // Save to backend
            try {
                const response = await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        note_id: activeCitationIndex + 1,
                        html: newFormatted
                    })
                });
                
                const data = await response.json();
                if (!data.success) {
                    console.warn('Update warning:', data.error);
                }
            } catch (error) {
                console.error('Update error:', error);
            }
            
            // Re-render list
            renderCitationList();
            
            // Move to next
            nextCitation();
        }
        
        function revertCitation() {
            if (activeCitationIndex < 0) return;
            
            const cite = currentCitations[activeCitationIndex];
            document.getElementById('formatted-citation').value = cite.original || '';
        }
        
        // ========== DOCUMENT DOWNLOAD ==========
        async function downloadDocument() {
            if (!currentSessionId) {
                alert('No document to download');
                return;
            }
            
            try {
                const response = await fetch(`/api/download/${currentSessionId}`);
                
                if (!response.ok) {
                    throw new Error('Download failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `citategenie_processed.docx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading document: ' + error.message);
            }
        }
        
        function resetDocument() {
            currentSessionId = null;
            currentCitations = [];
            activeCitationIndex = -1;
            
            document.getElementById('file-input').value = '';
            document.getElementById('file-info').classList.add('hidden');
            document.getElementById('download-area').classList.add('hidden');
            document.getElementById('output-type-badge').classList.add('hidden');
            document.getElementById('success-count').classList.add('hidden');
            document.getElementById('citation-count').textContent = '0 total';
            
            document.getElementById('editor-empty').classList.remove('hidden');
            document.getElementById('editor-panel').classList.add('hidden');
            document.getElementById('list-empty').classList.remove('hidden');
            document.getElementById('citation-list').innerHTML = `
                <div id="list-empty" class="text-center py-12 text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-3 opacity-30"></i>
                    <p class="text-sm font-medium">Upload a document to begin</p>
                    <p class="text-xs mt-1 text-gray-300">Style determines footnotes vs. author-date</p>
                </div>
            `;
        }
        
        // ========== PROCESSING OVERLAY ==========
        function showProcessingOverlay() {
            document.getElementById('processing-overlay').classList.remove('hidden');
        }
        
        function hideProcessingOverlay() {
            document.getElementById('processing-overlay').classList.add('hidden');
        }
        
        function updateProcessingStatus(message, progress) {
            document.getElementById('processing-step').textContent = message;
            document.getElementById('processing-progress').style.width = `${progress}%`;
        }
        
        // ========== PROCESSING SUMMARY ==========
        function showProcessingSummary(stats, bibTitle) {
            const container = document.getElementById('citation-list');
            const citationsFound = stats.citations_found || 0;
            const citationsResolved = stats.citations_resolved || 0;
            const errors = stats.errors || [];
            
            const successRate = citationsFound > 0 
                ? Math.round((citationsResolved / citationsFound) * 100) 
                : 100;
            
            container.innerHTML = `
                <div class="space-y-4">
                    <!-- Success Summary -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4 text-center">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-check-circle text-2xl text-green-600"></i>
                        </div>
                        <h3 class="font-bold text-green-800 mb-1">Processing Complete!</h3>
                        <p class="text-sm text-green-600">
                            ${citationsResolved} of ${citationsFound} citations resolved
                        </p>
                        <div class="mt-3 bg-white/50 rounded-lg px-3 py-2">
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-gray-500">Success rate</span>
                                <span class="font-bold text-green-700">${successRate}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
                                <div class="bg-green-500 h-1.5 rounded-full" style="width: ${successRate}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Output Info -->
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Output Format</h4>
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas ${outputType === 'footnote' ? 'fa-superscript' : 'fa-user-clock'} text-blue-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">
                                    ${outputType === 'footnote' ? 'Footnotes/Endnotes' : 'Author-Date Citations'}
                                </p>
                                <p class="text-xs text-gray-500">
                                    ${outputType === 'footnote' ? 'Updated in document' : `${bibTitle} section added`}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    ${errors.length > 0 ? `
                    <!-- Errors -->
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4">
                        <h4 class="text-xs font-bold text-red-600 uppercase tracking-wider mb-2">
                            <i class="fas fa-exclamation-triangle mr-1"></i> ${errors.length} Issue${errors.length > 1 ? 's' : ''}
                        </h4>
                        <ul class="text-xs text-red-600 space-y-1">
                            ${errors.slice(0, 3).map(e => `<li class="truncate">â€¢ ${escapeHtml(e)}</li>`).join('')}
                            ${errors.length > 3 ? `<li class="text-red-400">...and ${errors.length - 3} more</li>` : ''}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <!-- Download Prompt -->
                    <div class="text-center py-3">
                        <p class="text-xs text-gray-400">
                            <i class="fas fa-arrow-down mr-1"></i>
                            Download your processed document above
                        </p>
                    </div>
                </div>
            `;
        }
        
        // ========== UTILITIES ==========
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
